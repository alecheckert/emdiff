# emdiff
Maximum likelihood estimation for multi-state normal diffusion models

## What does it do?

`emdiff` is a Python analysis tool for trajectories generated by 
stroboscopic single particle tracking (SPT) experiments. Given
a set of trajectories, it estimates how many molecules are in 
distinct diffusive states and the diffusion coefficient corresponding
to each state.

`emdiff` models a set of trajectories as an unknown mixture of 
normal diffusive components. Each component is characterized by 
a diffusion coefficient.

## What doesn't it do?

`emdiff` does not check the quality of your raw data.

`emdiff` does not filter out any data. It will consider whatever
data you give it. There is a single optional filter to exclude
trajectories before a start frame, but that's it.

`emdiff` does not decide how many diffusive states are present
in your data. You decide that.

`emdiff` does not provide any visualizations of the result beyond
some simple histograms provided by the `plot` option.

`emdiff` expects you to understand your own experiment. You need to
know the frame interval, approximate localization error, and pixel size.

`emdiff` only launches the estimator from a single initial parameter
guess, and does not identify when the estimator has converged to a 
local rather than global maximum. The user can set the initial guess
via the `guess` argument.

`emdiff` does not deal with identifiability issues arising from 
interchangeability of the states. For instance, if we fit 
with `n` states, there will be at least `n!` maxima in parameter space
that come from permutations of the state identities. `emdiff` will 
simply converge to one of these maxima, then order the output
by increasing diffusion coefficient.

## Is there a limit on the number of states I can fit?

No. `emdiff` places no limit on the number of states.

Of course, more states mean more error.

## Is there a limit on the number of spatial dimensions?

No, with one fat caveat. `emdiff` supports analysis in any
number of spatial dimensions, which is set by the `pos_cols`
argument. See the ``Example usage'' section below.

The fat caveat is that `emdiff` models localization error
as identical along each spatial dimension. This is generally true
for 1D and 2D analyses. But for most
SPT experiments in 3D, tracking the position of moving objects 
in the axial (Z) direction is harder than in the lateral
(XY) directions. So the assumption of identical
localization error along each axis will be wrong for those
setups.

## Dependencies

`numpy`, `pandas`, `scipy`, `matplotlib`, `seaborn`. These are all
part of the standard [Anaconda](https://www.anaconda.com/products/individual) distribution. If you have 
[`matplotlib_scalebar`](https://pypi.org/project/matplotlib-scalebar/), 
the plots will have scalebars. So that's recommended too.

## Install

1. Clone the repository: `git clone https://github.com/alecheckert/emdiff.git`. 

2. Navigate to the top-level `emdiff` directory.

3. From a `conda` environment with the dependencies above, run `python setup.py develop`. 

`emdiff` is likely to change in the future. The `develop` option 
will track changes in the source files as new versions become available.

## Expected input

`emdiff` takes trajectories as a `pandas.DataFrame`. Each row of 
the dataframe should correspond to a localization from an SPT
experiment. The dataframe must contain at minimum:

 - a `trajectory` column, with the index of the trajectory to which that localization corresponds;
 - a `frame` column, with the index of the corresponding frame;
 - columns such as `y` and `x` with the spatial coordinates of the localization **in pixels**

See `samples/sample_tracks.csv` for an example.

## Example usage
```
    from emdiff import emdiff
    state_occupations, diff_coefs = emdiff(
        tracks,
        n_states=2,
        pos_cols=["y", "x"],     # columns in *tracks* with 
                                 # the spatial coordinates
        pixel_size_um=0.16,      # microns
        frame_interval=0.00748,  # seconds
        loc_error=0.035          # microns
    )
```

Also see `samples/sample_script.py`. 

## Example usage with plots
```
    from emdiff import emdiff

    # The output prefix for the plots, which are saved as PNGs
    plot_prefix = "my_dataset_name_emdiff_fits"

    # Run the core EM routine
    state_occupations, diff_coefs = emdiff(
        tracks,
        n_states=2,
        pos_cols=["y", "x"],
        pixel_size_um=0.16,
        frame_interval=0.00748,
        loc_error=0.035,
        plot=True,
        plot_prefix=plot_prefix
    )
```

## What do I do with the result?

Up to you.

## But I don't know the localization error for my experiment.

There are various ways to estimate the localization
error in an SPT experiment. `emdiff` provides one:
```
    from emdiff import calc_le
    loc_error = calc_le(
        tracks, 
        pixel_size_um=0.16,
        pos_cols=['y', 'x']
    )
```

This localization error represents the root 1D variance associated 
with estimating a particle's position at any given frame,
estimated using the covariance between subsequent displacements in 
a set of trajectories. It gets more accurate as you use more 
trajectories.

If this localization error seems large, then that's probably 
because it actually is. Moving molecules produce a lot of error
than the bound molecules that people usually measure localization
error with.

## Where can I find a description of the parameters to `emdiff`?

For now, see the docstring to the function `emdiff.em.emdiff`. 
In the future, you'll find a user guide in the `doc` folder to 
this repository.

